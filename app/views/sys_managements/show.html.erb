
<div class="center hero-unit">
<% provide(:title,'SysManagement-result') %>
<div>
	<div class="form-inline">
		<label>选择月份</label>
		<select id="dateSec" class="form-control" style="width:30%" onblur="getTerm()">
		<option value=""></option>
			<% for i in @termDate %>			
			<option value="<%= i.to_s[/\d+/] %>"> 
				<%= i.to_s[/\d+/] %> 
			</option>
			<% end %>
		</select>	
		<label>选择期数</label>
		<select id="phaseSec" class="form-control" style="width:45%">
				<option></option>	
		</select>
		<input type="button" class="btn btn-large btn-primary" id="getresault" value="确定">
		 
	</div>
	
</div>
<div style="display:none" id="results" class="">
	<!-- 当期得分结果 -->
	<table id="depart_result" data-row-style="rowStyle" data-toggle="depart_resault" data-search="true" data-show-export="true"  data-export-types="['excel']" data-export-options='{ "fileName": "scores", 
					       "worksheetName": "sheet1",         
					       "jspdf": {                  
					       "autotable": {
					      	    "styles": { "rowHeight": 20, "fontSize": 10 },
					            "headerStyles": { "fillColor": 255, "textColor": 0 },
					            "alternateRowStyles": { "fillColor": [60, 69, 79], "textColor": 255 }
					           }
					         }
					       }' >	 
	  <thead>
	    <tr>
	        <th data-field="department">部门</th>	    
	        <th data-field="master">评分对象</th>
	        <th data-field="score">得分</th>	 
	        <th data-field="operate">操作</th>	       
	    </tr>
      </thead>
	</table>
</div> 

<script type="text/javascript">
	// var terms;

	function rowStyle(row, index) {
	    var classes = ['active', 'success', 'info', 'warning', 'danger'];
	    if (row.master === '部门') {
	        return {
	            classes: classes[2]
	        };
	    }
	    return {};
	}


	$("#getresault").click(function(){
		var termPhase=document.getElementById("phaseSec").value
		var termDate=document.getElementById("dateSec").value
		if(termDate=="" && termPhase=="")
			alert("月份和期数不能为空");
		// if(termPhase=="" && termDate!="")
		// {
		// 	getMonthAvg();
		// }
		else
		{
			$.ajax({
				url: '/sys/getresult',
				type: 'post',
				data: {termPhase: termPhase,termDate: termDate},
				dataType: 'json',
				success: function(data){										
					var scores=eval("("+data["scores"]+")");
					// alert(departs.length);					
					document.getElementById("results").style.display="block"
						$(function () {														
						    $('#depart_result').bootstrapTable('destroy').bootstrapTable({
						        data: scores
						    });					    						

						});
				},
				error: function(xhr){
					alert("error");
				}
			})	
		}		
	})

	 
	function getDetail(TypeId){
		
		var termPhase=document.getElementById("phaseSec").value
		// var termDate=document.getElementById("dateSec").value
		// alert(TypeId);
		var id= TypeId.replace(/[^0-9]/ig,""); 
		if(TypeId.indexOf("ment") > 0)
			{
				var postdata={termPhase: termPhase,departID: id};
			}
		else
			{
				var postdata={termPhase: termPhase,masterID: id};
			}
		// alert(id);
		$.ajax({
			url: '/sys/detail',
			type:'post',
			data:postdata,
			dataType:'json',
			success: function(data){
				var employeelist=eval("("+data["employees"]+")");				
			    document.getElementById('light').style.display='block';
			    document.getElementById('fade').style.display='block';
				$(function () {														
				    $('#employee_list').bootstrapTable('destroy').bootstrapTable({
				        data: employeelist
				    });	 
				});
			},
			error: function(xhr){
					alert("error");
				}
		})
	}

 //根据月份获得期数
 	function getTerm(){
 		var date=document.getElementById('dateSec').value;
 		var phase=document.getElementById("phaseSec");

 		$.ajax({
 			url:'/sys/getterm',
 			type:'post',
 			data:{date: date},
 			success: function(data){ 				
 				// alert(1);
 				
 				phase.options.length=1;
 				for(var i=0;i<data.length;i++)
 				{ 			 							
 					var option=document.createElement("option");
 					phase.appendChild(option);
 					option.text=data[i]["phase"];
 					option.value=data[i]["phase"].replace(/[^0-9]+/g, '');
 				}

 				// terms=data.length;
 				 

 			},
 			error: function(xhr){
 				alert("error"+xhr);
 			}

 		})
 	}
	//求月度平均数
 // 	function getMonthAvg(date){
 // 		var test=document.getElementById("phaseSec").getElementsByTagName("option")
 // 		 // alert(test[0].value);
 // 		var departsList=new Array();
 // 		var mastersList=new Array();
 // 		var temp=0;
 // 		for(var i=0;i<test.length-1;i++)
 // 		{
 // 			$.ajax({
 // 				url:'/sys/getresult',
 // 				type: 'post',
 // 				data: {termPhase: test[i+1].value},
 // 				dataType: 'json',
 // 				success: function(data){
 // 					var departs=eval("("+data["depart"]+")");
	// 				var masters=eval("("+data["master"]+")");
	// 				// alert("success");
	// 				for(var j=0;j<departs.length;j++)

 // 				},
 // 				error: function(){
 // 					alert("error");
 // 				}
 // 			})
 // 		}
	// }
	//每次构造前要先把表格清空(首行除外)
	// function clearTable(table){
	//  var tb = document.getElementById(table);
 //     var rowNum=tb.rows.length;
 //     for (i=1;i<rowNum;i++)
 //     {
 //         tb.deleteRow(i);
 //         rowNum=rowNum-1;
 //         i=i-1;
 //     }
	// }

	
</script>

<div id="light" class="white_content"> 
  <div align="right">
    <span id="span2" style="cursor:pointer" onclick="document.getElementById('light').style.display='none';document.getElementById('fade').style.display='none'">×</span>
  </div>
    <div >
     <table id="employee_list"  data-search="true">	 
	  <thead>
	    <tr>
	        <th data-field="id">id</th>	        
	        <th data-field="name">评分人姓名</th>	
	        <th data-field="score">所给分数</th>     
	    </tr>
      </thead>
	</table>
    </div>
</div> 
  <div id="fade" class="black_overlay"> </div>